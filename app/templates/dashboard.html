<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="referrer" content="no-referrer">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="/static/js/tagcanvas.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/static/css/styles_dashboard.css">
    <style>
        /* 补充内联样式以确保 JS生成的卡片样式正确 */
        .video-cover {
            width: 140px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-card-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-thumb {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #ff5c8d;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        .video-thumb:hover { transform: scale(1.1); }
        .video-title {
            margin-top: 8px;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            text-align: center;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 36px;
            line-height: 18px;
        }
        .video-rt {
            margin-top: 5px;
            text-align: center;
            color: white;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
    <div id="header">
        <div style="display: flex;justify-content: space-between;align-items: center;">
            <img src="/static/img/logo.png" alt="Logo" id="logo">
            <span id="logo-text">bilibili Recommender</span>
        </div>
        <div style="display: flex; align-items: center;">
            <div id="avatar-container">
                <img src="/static/img/avatar.jpg" alt="Avatar" id="avatar">
            </div>
            <button id="logout-btn" class="logout-btn">Log Out</button>
        </div>
    </div>

    <div id="button-container">
        <button id="hot-video-btn" class="video-btn">热门精选</button>
        <button id="explore-btn" class="video-btn">兴趣探索</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="close-btn" class="close-btn">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="loading-part" style="display: none;">
                <i id="loading-text" style="color:darkgrey;">正在生成推荐列表 ...</i>
                <div id="loading-anime" class="loader"></div>
            </div>
            <div id="modal-body">
                <div id="recommend-hot-vid" style="flex: 1; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px;"></div>
                <div id="recommend-explore-vid" style="flex: 1; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px;"></div>
            </div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="main-content">
        <div id="your-interests">
            <h2 style="text-align: center; display: inline-block; margin: 0;">Your Interests</h2>
            <span style="font-size: 1em; color: gray; text-align: right; margin-top: 8px;">(基于您的收藏和历史观看)</span>

            <div style="display: flex; flex-direction: row; align-items: center; height: 45vh;">
                <div id="canvas-container" style="margin-left: auto; margin-right: auto;">
                    <canvas id="tag-cloud"></canvas>
                    <ul id="tagList" style="display:none;"></ul>
                </div>

                <div id="history-vid" style="flex: 1; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 安全解析历史数据
            const historyInfo = {{ history_info | tojson }} || [];

            const historyVidContainer = document.getElementById('history-vid');
            const tagListContainer = document.getElementById('tagList');
            let uniqueTags = new Set();

            // 渲染首页历史
            historyInfo.slice(0, 8).forEach(item => {
                const card = createVideoCard(item, false);
                historyVidContainer.appendChild(card);

                if(item.tag){
                    item.tag.forEach(tag => {
                        if (!uniqueTags.has(tag)) {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = "#"; a.textContent = tag;
                            li.appendChild(a);
                            tagListContainer.appendChild(li);
                            uniqueTags.add(tag);
                        }
                    });
                }
            });

            try {
                TagCanvas.Start('tag-cloud', 'tagList', {
                    textFont: 'Orbitron, sans-serif', textColour: '#FFFFFF', outlineColour: 'transparent',
                    reverse: true, depth: 0.7, maxSpeed: 0.1, textHeight: 12, wheelZoom: false, fadeIn: 2000, shape: 'sphere'
                });
            } catch (e) { console.log(e); }

            // 登出
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    fetch('/logout', { method: 'POST' }).then(r => r.json()).then(d => { if(d.success) window.location.href='/login'; });
                });
            }
        });

        // 通用卡片生成
        function createVideoCard(item, showRating) {
            let title = item.title || "无标题";
            let pic = item.pic || "/static/img/logo.png";
            let bvid = item.bvid || "";
            let ratingVal = (item.rating !== undefined && item.rating !== null) ? (item.rating * 100).toFixed(1) : "N/A";

            const div = document.createElement('div');
            div.className = 'video-cover';
            div.innerHTML = `
                <a href="https://www.bilibili.com/video/${bvid}" target="_blank" class="video-card-link">
                    <img src="${pic}" alt="${title}" class="video-thumb" onerror="this.src='/static/img/logo.png'">
                    <p class="video-title" title="${title}">${title}</p>
                    ${showRating ? `<p class="video-rt">RT: ${ratingVal}</p>` : ''}
                </a>
            `;
            return div;
        }

        // 弹窗逻辑
        const modal = document.getElementById('modal');
        const overlay = document.getElementById('overlay');
        const loadingPart = document.getElementById('loading-part');
        const modalTitle = document.getElementById('modal-title');

        function showModal(sel) {
            modal.style.display = 'flex';
            overlay.style.display = 'block';
            loadingPart.style.display = 'block';

            const isHot = sel === 'hot';
            const containerId = isHot ? 'recommend-hot-vid' : 'recommend-explore-vid';
            const apiPath = isHot ? '/api/recommend-hot-vid' : '/api/recommend-explore-vid';

            modalTitle.innerText = isHot ? '热门精选' : '兴趣探索';
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // 清空

            fetch(apiPath)
            .then(r => r.json())
            .then(data => {
                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="color:#666;">暂无数据，请稍后重试</p>';
                    return;
                }
                data.slice(0, 8).forEach(item => {
                    container.appendChild(createVideoCard(item, true));
                });
            })
            .catch(e => {
                console.error(e);
                container.innerHTML = '<p style="color:red;">加载失败</p>';
            })
            .finally(() => {
                loadingPart.style.display = 'none';
            });
        }

        function closeModal() {
            modal.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('recommend-hot-vid').innerHTML = '';
            document.getElementById('recommend-explore-vid').innerHTML = '';
        }

        document.getElementById('hot-video-btn').addEventListener('click', () => showModal('hot'));
        document.getElementById('explore-btn').addEventListener('click', () => showModal('explore'));
        document.getElementById('close-btn').addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);
    </script>
</body>
</html>